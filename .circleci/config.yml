# This file is generated by .circleci/config.rb, do not edit it manually!
# Edit .circleci/config.rb and run ruby .circleci/config.rb

version: '2.1'
jobs:
  check_config:
    docker:
    - image: railseventstore/ruby:2.7
    steps:
    - checkout
    - run:
        name: Verify .circleci/config.yml is generated from .circleci/config.rb
        command: WAS="$(md5sum .circleci/config.yml)" && ruby .circleci/config.rb
          && test "$WAS" == "$(md5sum .circleci/config.yml)"
  mutate_aggregate_root_ruby_2_7:
    docker:
    - image: railseventstore/ruby:2.7
      environment:
        MUTANT_JOBS: 4
    steps:
    - checkout
    - run: make -C aggregate_root install mutate-incremental
  mutate_bounded_context_ruby_2_7:
    docker:
    - image: railseventstore/ruby:2.7
      environment:
        MUTANT_JOBS: 4
    steps:
    - checkout
    - run: make -C bounded_context install mutate-incremental
  mutate_ruby_event_store_ruby_2_7:
    docker:
    - image: railseventstore/ruby:2.7
      environment:
        MUTANT_JOBS: 4
    steps:
    - checkout
    - run: make -C ruby_event_store install mutate-incremental
  mutate_ruby_event_store_browser_ruby_2_7:
    docker:
    - image: railseventstore/ruby:2.7
      environment:
        MUTANT_JOBS: 4
    steps:
    - checkout
    - run: make -C ruby_event_store-browser install mutate-incremental
  mutate_ruby_event_store_rom_ruby_2_7:
    docker:
    - image: railseventstore/ruby:2.7
      environment:
        MUTANT_JOBS: 4
    steps:
    - checkout
    - run: make -C ruby_event_store-rom install mutate-incremental
  mutate_rails_event_store_ruby_2_7:
    docker:
    - image: railseventstore/ruby:2.7
      environment:
        MUTANT_JOBS: 4
    steps:
    - checkout
    - run: make -C rails_event_store install mutate-incremental
  mutate_rails_event_store_active_record_ruby_2_7:
    docker:
    - image: railseventstore/ruby:2.7
      environment:
        MUTANT_JOBS: 4
    steps:
    - checkout
    - run: make -C rails_event_store_active_record install mutate-incremental
  mutate_rails_event_store_rspec_ruby_2_7:
    docker:
    - image: railseventstore/ruby:2.7
      environment:
        MUTANT_JOBS: 4
    steps:
    - checkout
    - run: make -C rails_event_store-rspec install mutate-incremental
  test_aggregate_root_ruby_2_7:
    docker:
    - image: railseventstore/ruby:2.7
      environment:
        DATABASE_URL: 'sqlite3::memory:'
    steps:
    - checkout
    - run: make -C aggregate_root install test
  test_bounded_context_ruby_2_7:
    docker:
    - image: railseventstore/ruby:2.7
      environment:
        DATABASE_URL: 'sqlite3::memory:'
    steps:
    - checkout
    - run: make -C bounded_context install test
  test_ruby_event_store_ruby_2_7:
    docker:
    - image: railseventstore/ruby:2.7
      environment:
        DATABASE_URL: 'sqlite3::memory:'
    steps:
    - checkout
    - run: make -C ruby_event_store install test
  test_ruby_event_store_browser_ruby_2_7:
    docker:
    - image: railseventstore/ruby:2.7
      environment:
        DATABASE_URL: 'sqlite3::memory:'
    steps:
    - checkout
    - run: make -C ruby_event_store-browser install test
  test_ruby_event_store_rom_ruby_2_7:
    docker:
    - image: railseventstore/ruby:2.7
      environment:
        DATABASE_URL: sqlite:db.sqlite3
    steps:
    - checkout
    - run: make -C ruby_event_store-rom install test
  test_rails_event_store_ruby_2_7:
    docker:
    - image: railseventstore/ruby:2.7
      environment:
        DATABASE_URL: 'sqlite3::memory:'
    steps:
    - checkout
    - run: make -C rails_event_store install test
  test_rails_event_store_active_record_ruby_2_7:
    docker:
    - image: railseventstore/ruby:2.7
      environment:
        DATABASE_URL: sqlite3:db.sqlite3
    steps:
    - checkout
    - run: make -C rails_event_store_active_record install test
  test_rails_event_store_rspec_ruby_2_7:
    docker:
    - image: railseventstore/ruby:2.7
      environment:
        DATABASE_URL: 'sqlite3::memory:'
    steps:
    - checkout
    - run: make -C rails_event_store-rspec install test
  test_aggregate_root_ruby_2_5:
    docker:
    - image: railseventstore/ruby:2.5
      environment:
        DATABASE_URL: 'sqlite3::memory:'
    steps:
    - checkout
    - run: make -C aggregate_root install test
  test_bounded_context_ruby_2_5:
    docker:
    - image: railseventstore/ruby:2.5
      environment:
        DATABASE_URL: 'sqlite3::memory:'
    steps:
    - checkout
    - run: make -C bounded_context install test
  test_ruby_event_store_ruby_2_5:
    docker:
    - image: railseventstore/ruby:2.5
      environment:
        DATABASE_URL: 'sqlite3::memory:'
    steps:
    - checkout
    - run: make -C ruby_event_store install test
  test_ruby_event_store_browser_ruby_2_5:
    docker:
    - image: railseventstore/ruby:2.5
      environment:
        DATABASE_URL: 'sqlite3::memory:'
    steps:
    - checkout
    - run: make -C ruby_event_store-browser install test
  test_ruby_event_store_rom_ruby_2_5:
    docker:
    - image: railseventstore/ruby:2.5
      environment:
        DATABASE_URL: sqlite:db.sqlite3
    steps:
    - checkout
    - run: make -C ruby_event_store-rom install test
  test_rails_event_store_ruby_2_5:
    docker:
    - image: railseventstore/ruby:2.5
      environment:
        DATABASE_URL: 'sqlite3::memory:'
    steps:
    - checkout
    - run: make -C rails_event_store install test
  test_rails_event_store_active_record_ruby_2_5:
    docker:
    - image: railseventstore/ruby:2.5
      environment:
        DATABASE_URL: sqlite3:db.sqlite3
    steps:
    - checkout
    - run: make -C rails_event_store_active_record install test
  test_rails_event_store_rspec_ruby_2_5:
    docker:
    - image: railseventstore/ruby:2.5
      environment:
        DATABASE_URL: 'sqlite3::memory:'
    steps:
    - checkout
    - run: make -C rails_event_store-rspec install test
  test_aggregate_root_ruby_2_6:
    docker:
    - image: railseventstore/ruby:2.6
      environment:
        DATABASE_URL: 'sqlite3::memory:'
    steps:
    - checkout
    - run: make -C aggregate_root install test
  test_bounded_context_ruby_2_6:
    docker:
    - image: railseventstore/ruby:2.6
      environment:
        DATABASE_URL: 'sqlite3::memory:'
    steps:
    - checkout
    - run: make -C bounded_context install test
  test_ruby_event_store_ruby_2_6:
    docker:
    - image: railseventstore/ruby:2.6
      environment:
        DATABASE_URL: 'sqlite3::memory:'
    steps:
    - checkout
    - run: make -C ruby_event_store install test
  test_ruby_event_store_browser_ruby_2_6:
    docker:
    - image: railseventstore/ruby:2.6
      environment:
        DATABASE_URL: 'sqlite3::memory:'
    steps:
    - checkout
    - run: make -C ruby_event_store-browser install test
  test_ruby_event_store_rom_ruby_2_6:
    docker:
    - image: railseventstore/ruby:2.6
      environment:
        DATABASE_URL: sqlite:db.sqlite3
    steps:
    - checkout
    - run: make -C ruby_event_store-rom install test
  test_rails_event_store_ruby_2_6:
    docker:
    - image: railseventstore/ruby:2.6
      environment:
        DATABASE_URL: 'sqlite3::memory:'
    steps:
    - checkout
    - run: make -C rails_event_store install test
  test_rails_event_store_active_record_ruby_2_6:
    docker:
    - image: railseventstore/ruby:2.6
      environment:
        DATABASE_URL: sqlite3:db.sqlite3
    steps:
    - checkout
    - run: make -C rails_event_store_active_record install test
  test_rails_event_store_rspec_ruby_2_6:
    docker:
    - image: railseventstore/ruby:2.6
      environment:
        DATABASE_URL: 'sqlite3::memory:'
    steps:
    - checkout
    - run: make -C rails_event_store-rspec install test
  test_bounded_context_rails_5_0:
    docker:
    - image: railseventstore/ruby:2.7
      environment: &1
        RAILS_VERSION: 5.0.7.2
    steps:
    - checkout
    - run: make -C bounded_context install test
  test_rails_event_store_rails_5_0:
    docker:
    - image: railseventstore/ruby:2.7
      environment: *1
    steps:
    - checkout
    - run: make -C rails_event_store install test
  test_rails_event_store_active_record_rails_5_0:
    docker:
    - image: railseventstore/ruby:2.7
      environment: *1
    steps:
    - checkout
    - run: make -C rails_event_store_active_record install test
  test_rails_event_store_rspec_rails_5_0:
    docker:
    - image: railseventstore/ruby:2.7
      environment: *1
    steps:
    - checkout
    - run: make -C rails_event_store-rspec install test
  test_bounded_context_rails_5_1:
    docker:
    - image: railseventstore/ruby:2.7
      environment: &2
        RAILS_VERSION: 5.1.7
    steps:
    - checkout
    - run: make -C bounded_context install test
  test_rails_event_store_rails_5_1:
    docker:
    - image: railseventstore/ruby:2.7
      environment: *2
    steps:
    - checkout
    - run: make -C rails_event_store install test
  test_rails_event_store_active_record_rails_5_1:
    docker:
    - image: railseventstore/ruby:2.7
      environment: *2
    steps:
    - checkout
    - run: make -C rails_event_store_active_record install test
  test_rails_event_store_rspec_rails_5_1:
    docker:
    - image: railseventstore/ruby:2.7
      environment: *2
    steps:
    - checkout
    - run: make -C rails_event_store-rspec install test
  test_bounded_context_rails_5_2:
    docker:
    - image: railseventstore/ruby:2.7
      environment: &3
        RAILS_VERSION: 5.2.4.4
    steps:
    - checkout
    - run: make -C bounded_context install test
  test_rails_event_store_rails_5_2:
    docker:
    - image: railseventstore/ruby:2.7
      environment: *3
    steps:
    - checkout
    - run: make -C rails_event_store install test
  test_rails_event_store_active_record_rails_5_2:
    docker:
    - image: railseventstore/ruby:2.7
      environment: *3
    steps:
    - checkout
    - run: make -C rails_event_store_active_record install test
  test_rails_event_store_rspec_rails_5_2:
    docker:
    - image: railseventstore/ruby:2.7
      environment: *3
    steps:
    - checkout
    - run: make -C rails_event_store-rspec install test
  test_rails_event_store_active_record_mysql_5:
    docker:
    - image: railseventstore/ruby:2.7
      environment: &4
        DATABASE_URL: mysql2://root:secret@127.0.0.1/rails_event_store?pool=5
    - image: mysql:5
      environment: &5
      - MYSQL_DATABASE=rails_event_store
      - MYSQL_ROOT_PASSWORD=secret
      command: "--default-authentication-plugin=mysql_native_password --max-connections=2000"
    steps:
    - checkout
    - run: make -C rails_event_store_active_record install test
  test_ruby_event_store_rom_mysql_5:
    docker:
    - image: railseventstore/ruby:2.7
      environment: *4
    - image: mysql:5
      environment: *5
      command: "--default-authentication-plugin=mysql_native_password --max-connections=2000"
    steps:
    - checkout
    - run: make -C ruby_event_store-rom install test
  test_rails_event_store_active_record_mysql_8:
    docker:
    - image: railseventstore/ruby:2.7
      environment: &6
        DATABASE_URL: mysql2://root:secret@127.0.0.1/rails_event_store?pool=5
    - image: mysql:8
      environment: &7
      - MYSQL_DATABASE=rails_event_store
      - MYSQL_ROOT_PASSWORD=secret
      command: "--default-authentication-plugin=mysql_native_password --max-connections=2000"
    steps:
    - checkout
    - run: make -C rails_event_store_active_record install test
  test_ruby_event_store_rom_mysql_8:
    docker:
    - image: railseventstore/ruby:2.7
      environment: *6
    - image: mysql:8
      environment: *7
      command: "--default-authentication-plugin=mysql_native_password --max-connections=2000"
    steps:
    - checkout
    - run: make -C ruby_event_store-rom install test
  test_rails_event_store_active_record_postgres_11:
    docker:
    - image: railseventstore/ruby:2.7
      environment: &8
        DATABASE_URL: postgres://postgres:secret@localhost/rails_event_store?pool=5
    - image: postgres:11
      environment: &9
      - POSTGRES_DB=rails_event_store
      - POSTGRES_PASSWORD=secret
      command: "-c max_connections=2000"
    steps:
    - checkout
    - run: make -C rails_event_store_active_record install test
  test_ruby_event_store_rom_postgres_11:
    docker:
    - image: railseventstore/ruby:2.7
      environment: *8
    - image: postgres:11
      environment: *9
      command: "-c max_connections=2000"
    steps:
    - checkout
    - run: make -C ruby_event_store-rom install test
  test_rails_event_store_active_record_postgres_12:
    docker:
    - image: railseventstore/ruby:2.7
      environment: &10
        DATABASE_URL: postgres://postgres:secret@localhost/rails_event_store?pool=5
    - image: postgres:12
      environment: &11
      - POSTGRES_DB=rails_event_store
      - POSTGRES_PASSWORD=secret
      command: "-c max_connections=2000"
    steps:
    - checkout
    - run: make -C rails_event_store_active_record install test
  test_ruby_event_store_rom_postgres_12:
    docker:
    - image: railseventstore/ruby:2.7
      environment: *10
    - image: postgres:12
      environment: *11
      command: "-c max_connections=2000"
    steps:
    - checkout
    - run: make -C ruby_event_store-rom install test
  test_ruby_event_store_rom_data_type_json:
    docker:
    - image: railseventstore/ruby:2.7
      environment:
        DATA_TYPE: json
        DATABASE_URL: postgres://postgres:secret@localhost/rails_event_store?pool=5
    - image: postgres:11
      environment:
      - POSTGRES_DB=rails_event_store
      - POSTGRES_PASSWORD=secret
      command: "-c max_connections=2000"
    steps:
    - checkout
    - run: make -C ruby_event_store-rom install test
  test_ruby_event_store_rom_data_type_jsonb:
    docker:
    - image: railseventstore/ruby:2.7
      environment:
        DATA_TYPE: jsonb
        DATABASE_URL: postgres://postgres:secret@localhost/rails_event_store?pool=5
    - image: postgres:11
      environment:
      - POSTGRES_DB=rails_event_store
      - POSTGRES_PASSWORD=secret
      command: "-c max_connections=2000"
    steps:
    - checkout
    - run: make -C ruby_event_store-rom install test
workflows:
  version: '2'
  Check configuration:
    jobs:
    - check_config
  Current Ruby:
    jobs:
    - test_aggregate_root_ruby_2_7
    - mutate_aggregate_root_ruby_2_7:
        requires:
        - test_aggregate_root_ruby_2_7
    - test_bounded_context_ruby_2_7
    - mutate_bounded_context_ruby_2_7:
        requires:
        - test_bounded_context_ruby_2_7
    - test_ruby_event_store_ruby_2_7
    - mutate_ruby_event_store_ruby_2_7:
        requires:
        - test_ruby_event_store_ruby_2_7
    - test_ruby_event_store_browser_ruby_2_7
    - mutate_ruby_event_store_browser_ruby_2_7:
        requires:
        - test_ruby_event_store_browser_ruby_2_7
    - test_ruby_event_store_rom_ruby_2_7
    - mutate_ruby_event_store_rom_ruby_2_7:
        requires:
        - test_ruby_event_store_rom_ruby_2_7
    - test_rails_event_store_ruby_2_7
    - mutate_rails_event_store_ruby_2_7:
        requires:
        - test_rails_event_store_ruby_2_7
    - test_rails_event_store_active_record_ruby_2_7
    - mutate_rails_event_store_active_record_ruby_2_7:
        requires:
        - test_rails_event_store_active_record_ruby_2_7
    - test_rails_event_store_rspec_ruby_2_7
    - mutate_rails_event_store_rspec_ruby_2_7:
        requires:
        - test_rails_event_store_rspec_ruby_2_7
  Ruby 2.5:
    jobs:
    - test_aggregate_root_ruby_2_5
    - test_bounded_context_ruby_2_5
    - test_ruby_event_store_ruby_2_5
    - test_ruby_event_store_browser_ruby_2_5
    - test_ruby_event_store_rom_ruby_2_5
    - test_rails_event_store_ruby_2_5
    - test_rails_event_store_active_record_ruby_2_5
    - test_rails_event_store_rspec_ruby_2_5
  Ruby 2.6:
    jobs:
    - test_aggregate_root_ruby_2_6
    - test_bounded_context_ruby_2_6
    - test_ruby_event_store_ruby_2_6
    - test_ruby_event_store_browser_ruby_2_6
    - test_ruby_event_store_rom_ruby_2_6
    - test_rails_event_store_ruby_2_6
    - test_rails_event_store_active_record_ruby_2_6
    - test_rails_event_store_rspec_ruby_2_6
  Rails 5.0:
    jobs:
    - test_bounded_context_rails_5_0
    - test_rails_event_store_rails_5_0
    - test_rails_event_store_active_record_rails_5_0
    - test_rails_event_store_rspec_rails_5_0
  Rails 5.1:
    jobs:
    - test_bounded_context_rails_5_1
    - test_rails_event_store_rails_5_1
    - test_rails_event_store_active_record_rails_5_1
    - test_rails_event_store_rspec_rails_5_1
  Rails 5.2:
    jobs:
    - test_bounded_context_rails_5_2
    - test_rails_event_store_rails_5_2
    - test_rails_event_store_active_record_rails_5_2
    - test_rails_event_store_rspec_rails_5_2
  MySQL 5:
    jobs:
    - test_rails_event_store_active_record_mysql_5
    - test_ruby_event_store_rom_mysql_5
  MySQL 8:
    jobs:
    - test_rails_event_store_active_record_mysql_8
    - test_ruby_event_store_rom_mysql_8
  Postgres 11:
    jobs:
    - test_rails_event_store_active_record_postgres_11
    - test_ruby_event_store_rom_postgres_11
  JSONB data type:
    jobs:
    - test_ruby_event_store_rom_data_type_json
  JSON data type:
    jobs:
    - test_ruby_event_store_rom_data_type_jsonb
